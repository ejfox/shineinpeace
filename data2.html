
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Shine in Peace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="css/style2.css" rel="stylesheet">
    
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
	<!--[if lte IE 8]>
	     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
	 <![endif]-->
	<script src="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.js"></script>
    <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.1"></script>
	<script src="js/tabletop.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/ICanHaz.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/moment.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/underscore.js" type="text/javascript" charset="utf-8"></script>	
    <script src="http://d3js.org/d3.v3.min.js"></script>
    
    <script src="js/nv.d3.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/src/utils.js" type="text/javascript" charset="utf-8"></script>
    
    <!-- ><link href="css/bootstrap-responsive.css" rel="stylesheet"> -->

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
    
    
    <link href='http://fonts.googleapis.com/css?family=Gudea:400,700,400italic' rel='stylesheet' type='text/css'>
  </head>

  <body>
    <div class="container-fluid" id="data-container">
	    <div id="section1">
			<div id="map">
                <h2 id="loading">Loading....</h2>
                
                <script id="homicidePop" type="text/html">
                <h2>Homicide on {{date2}}</h2>
                <div><strong class="victim-names">{{victims}}</strong> killed {{date}} at {{time}}</div>
                <div>Reported victims: <span class="number-of-victims">{{noofvictims}}</span></div>
                <div class="victim-address">{{address}}</div>
                <div class="detailed-description">
                    I am a detailed description of the event. Track through OPD with RD# {{rdNumber}}
                </div>
                </script>
                
                <script id="injuryPop" type="text/html">
                <h2>Shooting with Injury on {{date2}}</h2>
                <div>Reported victims: <span class="number-of-victims">{{noofvictims}}</span></div>
                <div>{{date}} at {{time}}</div>
                <div class="victim-address">{{address}}</div>
                <div class="detailed-description">
                    I am a detailed description of the event. Track through OPD with RD# {{rdNumber}}
                </div>
                </script>
                
                <script id="noInjuryPop" type="text/html">
                <h2>Shooting with No Injury on {{date2}}</h2>
                <div>Reported victims: <span class="number-of-victims">{{noofvictims}}</span></div>
                <div>{{date}} at {{time}}</div>
                <div class="victim-address">{{address}}</div>
                <div class="detailed-description">
                    I am a detailed description of the event. Track through OPD with RD# {{rdNumber}}
                </div>
                </script>
                
                <script id="shootPop" type="text/html">
                <h2>Shooting on {{date2}}</h2>
                <div>Reported victims: <span class="number-of-victims">{{noofvictims}}</span></div>
                <div>{{date}} at {{time}}</div>
                <div class="victim-address">{{address}}</div>
                <div class="detailed-description">
                    I am a detailed description of the event. Track through OPD with RD# {{rdNumber}}
                </div>
                </script>

			</div>
		
        <!-- 
		<div class="row-fluid">
			<div class="span3 topicstory">
				<h3>The Killings</h3>
				<img src="http://placehold.it/350x250" />
			</div>
			<div class="span3 topicstory">
				<h3>The Trauma</h3>
				<img src="http://placehold.it/350x250" />
			</div>
			<div class="span3 topicstory">
				<h3>The Solutions</h3>
				<img src="http://placehold.it/350x250" />
			</div>
			<div class="span3 topicstory">
				<h3>The Data</h3>
				<img src="http://placehold.it/350x250" />
			</div>			
		</div>
        -->
        
        <div id="map-story">
            <div id="sStepper">
                <div id="stepper-sections">
                    <div class="stepper-section" data-enter-callback="window.map.panTo([37.781027,-122.22393]); window.map.setZoom(12);" >
                        <h2>Shine in Peace</h2>
                        Introductory text. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                    </div>
                    <div class="stepper-section" data-enter-callback="window.map.panTo([37.805427,-122.272596]); window.map.setZoom(14);">
                        <h2>Downtown</h2>
                        <a href="#" 
                        data-lat="37.805427" 
                        data-lng="-122.272596">Downtown
                        </a>
                         dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                         <p><strong>See more stories from this neighborhood</strong></p>
                    </div>
                    
                    <div class="stepper-section" data-enter-callback="window.map.panTo([37.822701,-122.271481]); window.map.setZoom(15);">
                        <h2>Uptown</h2>
                        <a href="#" 
                        data-lat="37.822701" 
                        data-lng="-122.271481">Uptown
                        </a>
                         dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                         <p><strong>See more stories from this neighborhood</strong></p>
                    </div>
            
                    <div class="stepper-section" data-enter-callback="window.map.panTo([37.748729,-122.175522]); window.map.setZoom(14);">
                        <h2>West Oakland</h2>
                        <a href="#" 
                        data-lat="37.748729" 
                        data-lng="-122.175522">West Oakland
                        </a>
                         dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                         <p><strong>See more stories from this neighborhood</strong></p>
                    </div>
                    
                    
                    <div class="stepper-section" 
                    data-enter-callback="
                    window.toggleHexmap(); 
                    window.togglePoints(); 
                    
                    window.map.panTo([37.781027,-122.22393]); 
                    window.map.setZoom(12)" 
                    data-exit-callback="window.toggleHexmap();         window.togglePoints(); ">
                        <h2>Hexmap</h2>
                        This hexmap shows concentrations of victims. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. 
                    </div>
                    
                    
                    <div class="stepper-section" data-enter-callback="window.map.panTo([37.781027,-122.22393]); window.map.setZoom(12); map.removeLayer(window.shootingLayer); map.removeLayer(window.injuryLayer);" data-exit-callback="map.addLayer(window.shootingLayer); map.addLayer(window.injuryLayer);">
                        <h2>Just homicides</h2>
                        Only show homicide points on map. 
                    </div>
                    
                    <div class="stepper-section"
                    
                    data-exit-callback="window.scrollToData()">
                        <h2>Look at our data!</h2>
                        
                    </div>
                    
                    
                </div>
                


                
                <ul id="stepper-nav">
                    <li href="#prev" class="stepper-prev">Prev</li>
                    <li href="#next" class="stepper-next">Next</li>
                </ul>        
            </div>        
        </div>     
        
        
        
        <div id="left-map-menu">
            <h3>Map Options</h3>
            <ul id="category-list">
                <li class="active" id="points">Points<img src="img/map.points.png" alt="Map.Points"></li>
                <li id="hex">Victim heatmap<img src="img/map.hex.png" alt="Map.Hex"></li>
            </ul>
        </div>
        
        <div id="right-map-menu">
            <div id="map-incidents">
                <h3>Filter Map</h3>
                <ul class="nav nav-pills nav-stacked">
                    <li><a href="#">Homicides</a></li>
                    <li><a href="#">Shootings with injuries</a></li>
                    <li><a href="#">Shootings with no injuries</a></li>
                </ul>
            </div>
        </div>        
    </div>
    
    <div id="data" class="section section2">        
        <h1>Data Breakdown</h1>
        <ul id="fact-boxes">
            <li id="beat-breakdown">
                <h3>Incidents per police beat</h3>
                <svg class="chart"></svg>
                
            </li>
            
            <li id="hour-breakdown">
                <h3>Incident per hour</h3>
                <svg class="chart"></svg>
            </li>
            
            <li id="weekday-breakdown">
                <h3>Incident per weekday</h3>
                <svg class="chart"></svg>
                
            </li>
            
            <li id="injury-percentage" class="small-fact">
                <h3>Percentage of incidents that end in injury <strong>pie chart</strong></h3>
                <svg class="chart"></svg>                
            </li>
            
            
            <li id="time-day-mostshootings">
                <h3 >Time of day / Day of week with most shootings <strong>text</strong></h3>
            </li>
            
            <li>
                <h3>Number of victims / number of victims younger than 18 <strong>bar chart</strong></h3>
            </li>
            
            <li>
                <h3>Average victims per incident <strong>(bar chart)</strong></h3>
            </li>
        </ul>
    </div>
    
        


        <footer >
        	
        </footer>			





    </div><!--/.fluid-container-->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="js/bootstrap.js"></script>
    
<script type="text/javascript" charset="utf-8">
$(document).ready(function(){      
    
    

    
        
/*    Create the map     */
    
var pointData = [];
        
                
var homicide = []
,injury = []
,noInjury = []
,shooting = []
,everything = []

window.dotsColored = true


                d3.csv('https://docs.google.com/spreadsheet/pub?key=0ApAkxBfw1JT4dGNLVEJoWGthSmJvUVgyOG5YeW9ZN2c&single=true&gid=0&output=csv', function(error, _json){ showInfo(_json) })
	        
    function mapNewPoint(pointData){   
        
        // Create all of the popup HTML using ICH.js
        // Setting the 2nd argument as true returns an HTML string  
        var homicidePop = ich.homicidePop(pointData, true);
        var injuryPop = ich.injuryPop(pointData, true);
        var noInjuryPop = ich.noInjuryPop(pointData, true);
        var shootPop = ich.shootPop(pointData, true);  
        
        // Create a color based on the date (in UNIX format)
        var pntColor = colorScale(pointData.unix)                
                
		//place points
		if (pointData.homicidetag == "TRUE"){                       
            var pntLatLng = new L.LatLng(pointData.lat, pointData.lng)
            point = new L.circle(pntLatLng, 200, {
                color: "red",
                stroke: false,
                fillOpacity: 0.8
                        
            })
            
            colorPoint = new L.circle(pntLatLng, 200, {
                color: pntColor,
                stroke: false,
                fillOpacity: 0.8
                        
            })
            
            
            // Create a point with the default color set
            point.bindPopup(homicidePop)
            
            // Create a point with the color determined by time
            colorPoint.bindPopup(homicidePop) 
            
            // Push a colored point to the layer if the window.dotsColored is true
            if(window.dotsColored){
                homicide.push(colorPoint)
            }
            else {
                homicide.push(point)            
            }
            
		}
		else if (pointData.shootinjurytag == "TRUE") {
                        
            var pntLatLng = new L.LatLng(pointData.lat, pointData.lng)
            point = new L.circle(pntLatLng, 100, {
                color: '#7D010C',
                weight: 0,
                fillOpacity: 0.5                        
            })


            colorPoint = new L.circle(pntLatLng, 100, {
                color: pntColor, //'#7D010C',
                weight: 0,
                fillOpacity: 0.5                        
            })
                                    
            point.bindPopup(injuryPop)  
            colorPoint.bindPopup(injuryPop)  
                    
            if(window.dotsColored){ injury.push(colorPoint) }
            else { injury.push(point) }

		}
		else if (pointData.shoottag == "TRUE") {            
                                  
            var pntLatLng = new L.LatLng(pointData.lat, pointData.lng)
            point = new L.circle(pntLatLng, 75, {
                color: '#2A0004',
                stroke: false,
                fillOpacity: 0.45
                        
            })
            
            colorPoint = new L.circle(pntLatLng, 75, {
                color: pntColor,
                stroke: false,
                fillOpacity: 0.45
                        
            })
                                    
            point.bindPopup(shootPop) 
            colorPoint.bindPopup(shootPop)
            
            if(window.dotsColored){ shooting.push(colorPoint) }  
            else { shooting.push(point) }
		}                                            
    }
    
    var shootingLayer, injuryLayer, homicideLayer, colorLayer;
	
    
    
    
    
    
    //grab map info and plot
	function showInfo(data) {        
        var eventDates = []
        
        _.each(data, function(row){
            
            // We use the eventDates variable to generate a color scale
            // based on the dates of the events
            
            eventDates.push(+moment(row.DATE + " " + row.Year, "MMMM D YYYY" ))
            // Add the current time so the scale is always relative to now
            eventDates.push(+moment())
            
            
            // Create 2 date formats
            
            // dateFormat is a 'conversational' tone, like "2 months ago"
            var dateFormat = moment(row.DATE + " " + row.Year, "MMMM D YYYY" ).fromNow(false)
            
            // dateFormat2 is a 'formal' tone, like "Jan 2nd"
            var dateFormat2 = moment(row.DATE + " " + row.Year, "MMMM D YYYY" ).format("MMM Do")
                    
                    
            // Create an object for each map point
            insertMapInfo = {
                lat: parseFloat(row.LATITUDE)
                ,lng: parseFloat(row.LONGITUDE)
                ,beat: row.BEAT
                ,homicidetag: row.HomicideTag
                ,shootinjurytag: row.ShootInjuryTag
                ,shootnoinjurytag: row.ShootNoinInjuryTag
                ,shoottag: row.ShootTag
                ,address: row.ADDRESS
                ,date: dateFormat
                ,date2: dateFormat2
                ,time: row.TIME
                ,rdNumber: row.RD
                ,statute: row.STATUTE
                ,victims: row.Victims
                ,noofvictims: row.NoOfVictims
                ,unix: +moment(row.DATE + " " + row.Year, "MMMM D YYYY" )
            }
			
            // Add our object to our pointData array
			pointData.push(insertMapInfo)    
        })


        // Create our color scale based on the earliest/most recent
        // dates found in our data
        // and scales them between black (oldest) and red (most recent)
        colorScale = d3.scale.linear()
        .domain([d3.min(eventDates), d3.max(eventDates)])
        .range(["white", "black"])
                
                
                
                
        // Map all the points and then remove the loading div
		for (var i = 0; i < pointData.length; i++) {                     
            mapNewPoint(pointData[i])
            
            if(i == pointData.length - 1 ){ 
                $("#loading").hide();			
            } 			                                
		}
        


        // Add our layers to the window so that our callbacks in HTML can access them
        window.shootingLayer = shootingLayer = L.layerGroup(shooting).addTo(map);             
        window.injuryLayer   = injuryLayer   = L.layerGroup(injury).addTo(map);
        window.homicideLayer = homicideLayer = L.layerGroup(homicide).addTo(map);
        
                      
        // Tell Leaflet what layer to include as checkboxes in the controls
        var overlayMarkers = {                 
            "Homicides": homicideLayer,
            "Injuries": injuryLayer,
            "Shootings": shootingLayer
            }
                
                
            // Create the control, and define collapsed as false
            // otherwise the checkboxes are hidden initially
        map.addControl(L.control.layers(null,overlayMarkers,{               
            collapsed: false
        }))
                       
	}
	
    
    
    
// INITIALIZE MAP //
		
//initalize map
var map = window.map = L.map('map',{
	center: [37.781027,-122.22393],
	zoom: 12,
    scrollWheelZoom: false
})

map.attributionControl.addAttribution("Data Journalism by John Osborn");

var layer = new L.StamenTileLayer("toner-lite");
map.addLayer(layer);        
        
        
var layer3 = new L.StamenTileLayer("toner-lines");
//map.addLayer(layer3);
        
var layer2 = new L.StamenTileLayer("toner-labels");
//map.addLayer(layer2);


// TODO: I am trying to figure out how to toggle coloring
// the dots by date and their defaults... it's not really working
window.toggleDotColors = function toggleDotColors(){
    if(window.dotsColored) {
        window.dotsColored = false;
        return false;
    }
    else {
        window.dotsColored = true;
        return true;
    }
}

$("#dot-color-toggle").click(function(){
    toggleDotColors();
})


/*
$("#section2 a").click(function(){
    var center = {}
    
    center.lat = $(this).attr("data-lat")
    ,center.lng = $(this).attr("data-lng")
    
    //alert(center.lat + " " + center.lng)
    
    map.panTo([center.lat, center.lng])
    map.setZoom(14)

})
*/

// Logic for the left menu
$('#category-list li').click( function(){
    $('#category-list li').removeClass("active");
    $(this).addClass("active");
    console.log("PARENT", $(this).parent())
    
    var id = $(this).attr("id");
    
    
    if(id == "points") {
        togglePoints();
        toggleHexmap();        
    }
    else if (id == "hex") {
        if($("#hexmap").css("display") == "none") {
            toggleHexmap();
            togglePoints();
        }

    }
    
    
})

// Functions to toggle the points and the hexmap
window.toggleHexmap = function toggleHexmap() {
    if($("#hexmap").css("display") == "inline") { 
        $("#hexmap").hide();                
    }
    else {        

        $("#hexmap").show();
    }


}

window.togglePoints = function togglePoints() {

    if(!map.hasLayer(shootingLayer) 
    && !map.hasLayer(homicideLayer)
    && !map.hasLayer(injuryLayer)){

        map.addLayer(shootingLayer)
        map.addLayer(homicideLayer)
        map.addLayer(injuryLayer)    
       
    }
    else {             
        map.removeLayer(homicideLayer)
        map.removeLayer(injuryLayer)
        map.removeLayer(shootingLayer) 
    }


}



/* Hexmap stuff */
var svg = d3.select(map.getPanes().overlayPane).append("svg"),
    g = svg.append("g").attr("class", "leaflet-zoom-hide");
    
    // Initially hide the hexmap, we'll have a button to show it
    g.style("display", "none").attr("id", "hexmap")
    
d3.json("data/oakland_victims.geojson", function(collection){    
    makeHexBin(collection);

    // Convert our D3 projections to leaflet
    function project(x) {
        var point = map.latLngToLayerPoint(new L.LatLng(x[1], x[0]));
        return [point.x, point.y];
    }

    function makeHexBin(collection) {        
        var bounds = d3.geo.bounds(collection),
            bottomLeft = project(bounds[0]),
            topRight = project(bounds[1]);
    
        var path = d3.geo.path().projection(project);
        
        
        // Create the scale for each hex based on how many victims
        var incidentMin = d3.min(collection.features, function(r) {  return r.properties.Victims }),
        incidentMax = d3.max(collection.features, function(r) { return r.properties.Victims        });        
        
        // Scale between 0 and 0.95 because it's for opacity
        // because it can be 0-1
        var incidentScale = d3.scale.linear()
        .domain([0, incidentMax])
        .range([0.05,1])
        

        var incidentScaleColor = d3.scale.linear()
            .domain([0, incidentMax])
            .interpolate(d3.interpolateHsl)
            .range(['black', '#D40067'])
    
    

        var feature = g.selectAll("path")
            .data(collection.features)
            .enter().append("path");      
            
            // Redraw the thing when the map does anything
            map.on("viewreset", hexReset);
            hexReset();
            
            function hexReset() {
                
                // The color used for the hexmap
                // Data is represented by opacity      
                var highlightColor = "black";
                
                var bottomLeft = project(bounds[0]),
                topRight = project(bounds[1])
                
                svg.attr("width", topRight[0] - bottomLeft[0])
                .attr("height", bottomLeft[1] - topRight[1])
                .style("margin-left", bottomLeft[0] + "px")
                .style("margin-top", topRight[1] + "px")
                
                g.attr("transform", "translate(" + -bottomLeft[0] + "," + -topRight[1] + ")")
                
                feature.attr("d", path)
                

                feature.style("fill-opacity", function(d,i) {
                    if(d.properties.Victims != undefined ){
                    return incidentScale(parseInt(d.properties.Victims))                                }
                })
                
                feature.style("fill", function(d,i){
                    if(d.properties.Victims != undefined ){
                        return incidentScaleColor(parseInt(d.properties.Victims))                          }
                })
                
                feature
                //.style("fill", highlightColor)
                .style("stroke", function(d,i) {
                    if(d.properties.Victims > 0) {
                        return highlightColor
                    }
                    else {
                        return "rgba(200,200,200,0.85)"
                    }
                
                })
                .style("stroke-width", 0.5)
                                            
            }      
    }	    

})    
	
/*
// api settings
L.tileLayer('http://{s}.tile.cloudmade.com/c74f93f2a2fc45b4a8a625de2e5bbbb8/998/256/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
    maxZoom: 18
}).addTo(map);
*/
    
})


// Smooth scrolling



$('a[href*=#]:not([href=#])').click(function() {
    if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') 
        || location.hostname == this.hostname) {

        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
           if (target.length) {
             $('html,body').animate({
                 scrollTop: target.offset().top
            }, 1600);
            return false;
        }
    }
});

window.scrollToData = function scrollToData() {
        var target = $("#data");
        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
           if (target.length) {
             $('html,body').animate({
                 scrollTop: target.offset().top - 24
            }, 1600);
            return false;
        }
    }

</script>

<script src="js/sStepper.js" type="text/javascript" charset="utf-8"></script>
    
<script type="text/javascript" charset="utf-8">
$(document).ready(function(){      
        
    sStepper.init("#sStepper");  

})
</script>

<script type="text/javascript" charset="utf-8">



var makePieChart = function makePieChart(targetElement, data) {
    
    console.log("piedata", data)
    
    var pieData = []
    
    pieData = [
        {
            key: "Injuries"
            ,y: parseInt(data.TRUE)
        }
        ,{
            key: "No injuries"
            ,y: parseInt(data.FALSE)
        }
    ]

    var chart;
    nv.addGraph(function() {
 
        $targetElement = $(targetElement)

        var width = $targetElement.width(),
        height = $targetElement.height();
  


        chart = nv.models.pieChart()
            .x(function(d) { return d.key })
            .y(function(d) { return d.y })
            //.showLabels(false)
            .values(function(d) { return d })
            //.color(d3.scale.category10().range())
            .color(function(d,i){ if( i % 2 == 0 ) { return "black"} else { return "#999"} })            
            //.width(width)
            //.height(height);

          d3.select(targetElement+" .chart")
              .datum([pieData])
            .transition().duration(1200)
              .attr('width', width)
              .attr('height', height)
              .call(chart);

        return chart;
    });


}
var makeBarChart = function makeBarchart(targetElement, data) {

    $targetElement = $(targetElement)

    var width = $targetElement.width(),
    height = $targetElement.height();
  
      nv.addGraph({
        generate: function() {
            
        dataBreakdown = data
        console.log("DATA", data)
        
        console.log(dataBreakdown)
        
        // TODO: Find a better way to sort that doesn't fuck up the objects
        /*
        dataBreakdown = _.sortBy(dataBreakdown, function(row,i){
            if(targetElement == "#beat-breakdown") {
                return -row
            }
            else {
                return i
            }
        })
        */
        dataBreakdown = _.map(dataBreakdown, function(row, i){
            
            if(targetElement == "#hour-breakdown") {
                console.log("ROW", row)
                var ourHour = moment(i.toString(), "H")
                
                i = ourHour.format("ha")
            
            }
           
            return {
                "label": i,
                "value": row              
            }
        })
        
            
        
          var chart = nv.models.discreteBarChart()
              //.showValues(true)
              .tooltips(true)
              //.width(width)
              //.height(height)
              .x(function(d){ return d.label })
              .y(function(d){ return d.value })
              .color(function(){ return "black" })
              .margin({top: 24, right: 36, bottom: 24, left: 36})
                           
              
          
          d3.select(targetElement+" .chart")
            .attr('width', width)
            .attr('height', height)
            .datum([{
                key: "Hour breakdown",
                values: dataBreakdown
            }])
            .call(chart);
            
            
            chart.yAxis
            
                        
          return chart;
        },
        callback: function(graph) {


          /*
          graph.dispatch.on('elementClick', function(e) {
              console.log("Bar Click",e);
          });

          graph.dispatch.on('chartClick', function(e) {
              console.log("Chart Click",e);
          });

          graph.dispatch.on('chartClick', function(e) {
              console.log('Click Switching to');
              if (td === 0) {
                  d3.select("#test1")
                          .datum(testdata2)
                          .call(graph);
                  td = 1;

              } else {
                  d3.select("#test1")
                          .datum(testdata)
                          .call(graph);
                  td = 0;
              }
            });
          */


          /*
          window.onresize = function() {
          
          var width = $targetElement.width(),
          height = $targetElement.height();
          
          
            graph
              .width(width)
              .height(height)

            d3.select(targetElement+" .chart")
                .attr('width', width)
                .attr('height', height)
              .call(graph);
          };
          
          */
        }
      });
} 




// Data / stats stuff

d3.csv('https://docs.google.com/spreadsheet/pub?key=0AnZDmytGK63SdHZoYWM5UklxaXI4bEpqS3cta1hid1E&output=csv', function(error, _json){
        
      console.log(_json[0])
      
      
      var count = {}
      
      count.shootings = _json.length
      
      count.beat = _.countBy(_json, function(d){ return d.BEAT })
      count.desc = _.countBy(_json, function(d){ return d.DESCRIPTION })
      count.homicides = _.countBy(_json, function(d){ return d.HomicideTag })
      count.injuries = _.countBy(_json, function(d){ return d.ShootInjuryTag })
      count.hourBreakdown = _.countBy(_json, function(d){ return moment(d.TIME, "h:m A" ).format("HH"); })
      count.dayBreakdown = _.countBy(_json, function(d){  return moment(d.DATE + " " + d.Year, "MMMM DD YYYY" ).format("ddd"); })
      
      
      console.log("COUNT!", count)
      
      makeBarChart("#hour-breakdown", count.hourBreakdown)

      makeBarChart("#weekday-breakdown", count.dayBreakdown)
      
      makeBarChart("#beat-breakdown", count.beat)
      
      makePieChart("#injury-percentage", count.injuries)
      
      
    })
    
    
   

</script>
	
	

  </body>
</html>
